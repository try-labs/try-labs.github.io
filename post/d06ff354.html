<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>孔乙己“茴”字四种写法引起我对策略模式实现的思考 | Sam的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="关于策略模式的文章，其实网上实在是太多了，自己的又没有啥文采，肯定也是写不出来什么花！但是我突然想起了孔乙己，对没错就是那个知道“茴”字有四种写法的孔乙己。当时，语文老师说这个场景是为了表现孔乙己的一种迂腐封建的性格。可是我对孔乙己的“茴”字有四种写法，一直有着不同的看法。我倒是觉得从某种意思上知道四种写法反倒是好事，比如你老板安排你做一件事情，你有四种不同的方案可以解决，这难道不是一件好事情嘛！">
<meta name="keywords" content="设计模式,思考,策略模式">
<meta property="og:type" content="article">
<meta property="og:title" content="孔乙己“茴”字四种写法引起我对策略模式实现的思考">
<meta property="og:url" content="https:&#x2F;&#x2F;ydstudios.gitee.io&#x2F;post&#x2F;d06ff354.html">
<meta property="og:site_name" content="Sam的个人博客">
<meta property="og:description" content="关于策略模式的文章，其实网上实在是太多了，自己的又没有啥文采，肯定也是写不出来什么花！但是我突然想起了孔乙己，对没错就是那个知道“茴”字有四种写法的孔乙己。当时，语文老师说这个场景是为了表现孔乙己的一种迂腐封建的性格。可是我对孔乙己的“茴”字有四种写法，一直有着不同的看法。我倒是觉得从某种意思上知道四种写法反倒是好事，比如你老板安排你做一件事情，你有四种不同的方案可以解决，这难道不是一件好事情嘛！">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210223205336.png">
<meta property="og:updated_time" content="2021-02-23T12:59:30.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;gitee.com&#x2F;ydstudios&#x2F;blogImage&#x2F;raw&#x2F;master&#x2F;img&#x2F;20210223205336.png">
  
    <link rel="alternate" href="/atom.xml" title="Sam的个人博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Sam的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">一个程序员的成长记录</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">首页</a>
        
          <a class="main-nav-link" href="/archives">归档</a>
        
          <a class="main-nav-link" href="/about">关于</a>
        
          <a class="main-nav-link" href="/links">友链</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ydstudios.gitee.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-孔乙己“茴”字四种写法引起我对策略模式实现的思考" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/post/d06ff354.html" class="article-date">
  <time datetime="2021-02-23T20:29:36.000Z" itemprop="datePublished">2021-02-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      孔乙己“茴”字四种写法引起我对策略模式实现的思考
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>关于策略模式的文章，其实网上实在是太多了，自己的又没有啥文采，肯定也是写不出来什么花！但是我突然想起了孔乙己，对没错就是那个知道“茴”字有四种写法的孔乙己。当时，语文老师说这个场景是为了表现孔乙己的一种迂腐封建的性格。可是我对孔乙己的“茴”字有四种写法，一直有着不同的看法。我倒是觉得从某种意思上知道四种写法反倒是好事，比如你老板安排你做一件事情，你有四种不同的方案可以解决，这难道不是一件好事情嘛！于是，我还是觉得这篇文章还是有写的必要，让大家看看“茴”字有不同的写法。</p>
<a id="more"></a>

<p><img src="https://gitee.com/ydstudios/blogImage/raw/master/img/20210223205336.png" alt="茴字四种写法"></p>
<p>假设目前有个抽奖的业务场景，奖品共有现金、优惠券、积分和谢谢参与四类，后续很大可能增加新的奖品类型如赠送抽奖次数。用户抽中则实时发送给用户。一般的小伙伴如何实现这个奖品发放的逻辑，我来写一下伪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Byte rewardType, String reward)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (rewardType.equals(<span class="string">"积分"</span>)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送积分奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rewardType.equals(<span class="string">"优惠券"</span>)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送优惠券奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rewardType.equals(<span class="string">"现金"</span>)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送现金奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rewardType.equals(<span class="string">"谢谢参与"</span>)) &#123;</span><br><span class="line">           log.info(<span class="string">"对不起，谢谢参与[&#123;&#125;]"</span>, reward);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>大家看一看这种代码，是不是感觉似曾相似，心里是不是在想“这不就是我写的么”！写过这种代码也没有什么不好意思的，毕竟大部分人都是普通人不是那种一个顶十个的大牛，笔者之前也是经常写这种代码，毕竟那个时候也不了解什么是好代码、如何写出好代码，此处必须提大牛Martin Fowler(马丁.福勒)，他的著作《重构》大家可以看看。在此，我想强调的是过去写不出优秀的代码不重要，重要的是现在你要知道什么是优秀的代码和如何写出优秀的代码，不然你多年工作经验的沉淀在哪里呢？</p>
<blockquote>
<p>任何一个傻瓜都能写出计算机可以理解的代码。唯有写出人类容易理解的代码，才是优秀的程序员。—— Martin Fowler(马丁.福勒)</p>
</blockquote>
<h4 id="问题在哪里"><a href="#问题在哪里" class="headerlink" title="问题在哪里"></a>问题在哪里</h4><p>现在我们来说说这段伪代码到底有哪些不好的地方：</p>
<ol>
<li>NPE的问题。 在没有对入参进行校验的情况下，直接使用 <code>rewardType.equals(&quot;积分&quot;)</code>进行判断，若rewardType值是null，这个地方就会出现空指针异常。</li>
<li>硬编码问题。奖励类型的魔法值后期多处拷贝，有可能出现拼写错误，也无法很好展示到底有多少奖励类型。</li>
<li>过多的if else会导致嵌套过深和逻辑表达式复杂。</li>
<li>违反开闭原则（OCP）和单一职责原则（SRP）。需求明确提出后续可能会增加“赠送抽奖次数”的奖品类型，按照目前代码的结构要增加发送新型的奖品，则势必需要修改<code>sendReward()</code>代码，增加一个新的分支，这样就修改了原来的代码，就会需要对此处的代码进行回归测试。</li>
</ol>
<h4 id="如何改进"><a href="#如何改进" class="headerlink" title="如何改进"></a>如何改进</h4><p>根据上面提到的问题我们给出针对性的优化意见。</p>
<ol>
<li><p>调换equals双方的位置 <code>&quot;积分&quot;.equals(rewardType)</code>或者使用<code>java.util.Objects.equals()</code>等等方法替代。</p>
</li>
<li><p>定义一个奖励类型枚举。</p>
</li>
<li><p>使用卫语句优化判断。</p>
</li>
</ol>
<p>使用上面三个优化意见我们来修改伪代码，最终伪代码呈现如下：</p>
<p>定义一个奖励类型枚举</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> RewardTypeEnum &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 现金奖励</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CASH(<span class="string">"1"</span>,<span class="string">"现金"</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 积分</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    POINT(<span class="string">"2"</span>,<span class="string">"积分"</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 优惠券</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    COUPON(<span class="string">"3"</span>,<span class="string">"优惠券"</span>),</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 谢谢参与</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    THANK_YOU(<span class="string">"4"</span>,<span class="string">"谢谢参与"</span>),</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String desc;</span><br><span class="line"></span><br><span class="line">    RewardTypeEnum(String code, String desc) &#123;</span><br><span class="line">        <span class="keyword">this</span>.code = code;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改后的发送奖励伪代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(String rewardType, String reward)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (RewardTypeEnum.POINT.getCode().equals(rewardType)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送积分奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (RewardTypeEnum.COUPON.getCode().equals(rewardType)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送优惠券奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (RewardTypeEnum.CASH.getCode().equals(rewardType)) &#123;</span><br><span class="line">           log.info(<span class="string">"发送现金奖励[&#123;&#125;]"</span>, reward);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (RewardTypeEnum.THANK_YOU.getCode().equals(rewardType)) &#123;</span><br><span class="line">           log.info(<span class="string">"对不起，谢谢参与[&#123;&#125;]"</span>, reward);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>对于问题4的解决，我们先需要思考一下。奖励的种类目前有四种，后续很有可能增加奖励种类，不同的奖励发放给用户肯定是涉及了不同的模块，调用不同的发放接口，最终的数据肯定也是写到不同的数据表中，这种情况明显是不同奖励有着不同的发放策略，很明显大家都能想到符合<code>策略模式</code>，本文的主角终于出场了！</p>
<p>策略模式属于设计模式中行为模式的一种，它主要是将算法封装起来，并且可以相互的替换。在看一些关于设计模式的书时，策略模式首先会定义一个接口，然后具体的策略类去实现策略接口，最后再定义一个<code>Context</code>上下文类来持有一个具体的策略以供调用者使用。这里其实有个问题好多书籍或者博客并没有说明，如何更优雅的让上下文类来持有一个具体的策略，这里我先搭建一下代码的框架，这个问题后面再细说。</p>
<h4 id="定义策略接口"><a href="#定义策略接口" class="headerlink" title="定义策略接口"></a>定义策略接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送奖励</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> memberId 会员id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h5 id="发送优惠券的策略"><a href="#发送优惠券的策略" class="headerlink" title="发送优惠券的策略"></a>发送优惠券的策略</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CouponRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"给[&#123;&#125;]发送优惠券奖品[&#123;&#125;]"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="发送积分的策略"><a href="#发送积分的策略" class="headerlink" title="发送积分的策略"></a>发送积分的策略</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PointRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"给[&#123;&#125;]发送积分奖品[&#123;&#125;]"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="谢谢参与的策略"><a href="#谢谢参与的策略" class="headerlink" title="谢谢参与的策略"></a>谢谢参与的策略</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThankYouRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"[&#123;&#125;]，对不起，谢谢参与"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="发送现金策略"><a href="#发送现金策略" class="headerlink" title="发送现金策略"></a>发送现金策略</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CashRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"给[&#123;&#125;]发送现金奖品"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="定义Context上下文类"><a href="#定义Context上下文类" class="headerlink" title="定义Context上下文类"></a>定义Context上下文类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RewardSendStrategyContext</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Context持有具体策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> RewardSendStrategy sendStrategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSendStrategy</span><span class="params">(RewardSendStrategy sendStrategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sendStrategy = sendStrategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">excute</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        sendStrategy.sendReward(memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="单元测试，试试如何使用"><a href="#单元测试，试试如何使用" class="headerlink" title="单元测试，试试如何使用"></a>单元测试，试试如何使用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123;<span class="string">"classpath:spring/spring-dao.xml"</span>, <span class="string">"classpath:spring/spring-service.xml"</span>&#125;)</span><br><span class="line"><span class="meta">@RunWith</span>(value = SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">StrategyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RewardSendStrategyContext context = <span class="keyword">new</span> RewardSendStrategyContext();</span><br><span class="line">        context.setSendStrategy(<span class="keyword">new</span> CouponRewardSendStrategy());</span><br><span class="line">        context.excute(<span class="number">11L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>单元测试的执行结果不用怀疑,肯定打印出了 <code>给[11]发送优惠券奖品</code>，但是这种调用方式我感觉并没有解决掉if else多级逻辑判断，为什么这么说，因为这个地方我知道我调用的是发放优惠券的策略，但是在实际业务调用中，我并不知道要发送什么类型奖品，我还是要根据传入的奖品类型去判断使用不同的奖品发送策略。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String rewardType = RewardTypeEnum.THANK_YOU.getCode();</span><br><span class="line">        RewardSendStrategyContext strategyContext = <span class="keyword">new</span> RewardSendStrategyContext();</span><br><span class="line">        <span class="keyword">if</span> (RewardTypeEnum.POINT.getCode().equals(rewardType)) &#123;</span><br><span class="line">            strategyContext.setSendStrategy(<span class="keyword">new</span> PointRewardSendStrategy());</span><br><span class="line">            strategyContext.excute(<span class="number">11L</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (RewardTypeEnum.COUPON.getCode().equals(rewardType)) &#123;</span><br><span class="line">            strategyContext.setSendStrategy(<span class="keyword">new</span> CouponRewardSendStrategy());</span><br><span class="line">            strategyContext.excute(<span class="number">11L</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (RewardTypeEnum.CASH.getCode().equals(rewardType)) &#123;</span><br><span class="line">            strategyContext.setSendStrategy(<span class="keyword">new</span> CashRewardSendStrategy());</span><br><span class="line">            strategyContext.excute(<span class="number">11L</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (RewardTypeEnum.THANK_YOU.getCode().equals(rewardType)) &#123;</span><br><span class="line">            strategyContext.setSendStrategy(<span class="keyword">new</span> ThankYouRewardSendStrategy());</span><br><span class="line">            strategyContext.excute(<span class="number">11L</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>按照我们前面给的建议进行优化，代码貌似又回到了起点。上面的代码明显还是不符合开闭原则和单一原则，看来我们还是需要进一步的优化。</p>
<h4 id="使用Spring框架的特性改进"><a href="#使用Spring框架的特性改进" class="headerlink" title="使用Spring框架的特性改进"></a>使用Spring框架的特性改进</h4><p>前面我们已经把发送不同奖品的逻辑分散到了各个单独的类中，这些操作符合单一职责原则。但是没有统一入口，导致在调用策略的地方还是出现了大片的if判断，使得代码还是没有满足开闭原则。所以接下来我们要做的就是干掉这些if判断，提供一个易用的调用接口。</p>
<p>那怎么样我们才能减少或者直接消除上述代码中存在的 if 判断呢？回想之前的一篇文章<a href="https://juejin.cn/post/6923476874941169671" target="_blank" rel="noopener">船新版本的策略模式，你一定没有见过</a> ，在这个文章中我用注解标识每个策略方法，以注解的值为key，策略方法为value保存在Map中，然后通过Map的 <code>get()</code>获取具体的策略方法，省去了 if 判断。这个其实就是表驱动法，是一种很经典的编程技巧。那在这里就继续用这种方式来解决我们目前遇到的问题。当然此时我们不需要自定义注解，也不需要反射调用，不需要那么大费周章。Spring是一个很优秀的Java框架，一般做Java开发都是基于Spring框架的，Spring框架里有很多特性、技巧能帮助我们写出更优秀的代码。接下来我就展示一下如何使用Spring框架让我们的代码质量更上一个层次。</p>
<p>在此之前我需要修改一下之前的接口，我们在接口中再定义两个方法，其中一个方法是标识当前类的奖励类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发放奖励的类型,通过这个方法来标示不同的策略</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">type</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否匹配</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 奖励类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String type)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送奖励</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> memberId 会员id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按照这种接口定义，我们在相应的策略类里实现相关方法，这里只给出策略类一个作为示范。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CouponRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RewardTypeEnum.COUPON.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(type, type());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"给[&#123;&#125;]发送优惠券奖品"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>好了，准备工作做的差不多了，接下来来显示Spring框架的威力吧！让它来帮组装我们需要的Map！</p>
<h5 id="方案一-Autowired注解"><a href="#方案一-Autowired注解" class="headerlink" title="方案一@Autowired注解"></a>方案一<code>@Autowired</code>注解</h5><p>这个注解大家肯定用过很多次了，我们常用它来注入其他的Bean，但是大家可能还有人不知道它有这种技能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* &lt;p&gt;In <span class="keyword">case</span> of a &#123;<span class="meta">@link</span> java.util.Collection&#125; or &#123;<span class="meta">@link</span> java.util.Map&#125;</span><br><span class="line">* dependency type, the container will autowire all beans matching the</span><br><span class="line">* declared value type. In <span class="keyword">case</span> of a Map, the keys must be declared as</span><br><span class="line">* type String and will be resolved to the corresponding bean names.</span><br></pre></td></tr></table></figure>
<p>这个是@Autowired注解源码上的注释，大致意思我举例说明</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 这样定义属性的时候，Spring 会自动的将这个接口的实现类bean全都自动添加到这个 rewardSendStrategyList 中</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> List&lt;RewardSendStrategy&gt; rewardSendStrategyList;</span><br><span class="line"></span><br><span class="line"># 这样定义属性的时候，Spring 会自动的以实现类 beanName 作为 key，bean 作为 value 添加到这个 Map 中</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span>  Map&lt;String, RewardSendStrategy&gt; strategyMap;</span><br></pre></td></tr></table></figure>
<p>666，就差一点我就要给你打一百分了，借此特性我们可以很容易的实现我们的Map，之前的Context类我们稍加修改,再借助一下Lamda表达式，我们得到了如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RewardSendStrategyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;RewardSendStrategy&gt; strategyList;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RewardSendStrategy <span class="title">getImpl</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> strategyList.stream()</span><br><span class="line">                .filter(strategy -&gt; strategy.isTypeMatch(type))</span><br><span class="line">                .findAny()</span><br><span class="line">                .orElseThrow(() -&gt; <span class="keyword">new</span> RuntimeException(<span class="string">"没有找到策略实现"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>这样一来我们调用就方便多了，而且很丝滑哦！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123;<span class="string">"classpath:spring/spring-dao.xml"</span>, <span class="string">"classpath:spring/spring-service.xml"</span>&#125;)</span><br><span class="line"><span class="meta">@RunWith</span>(value = SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">StrategyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RewardSendStrategyFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RewardSendStrategy strategy = factory.getImpl(RewardTypeEnum.POINT.getCode());</span><br><span class="line">        strategy.sendReward(<span class="number">11L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看着单元测试输出的结果，我感觉终于找到了完美实现策略模式的方案了。哈哈，其实还有好几种，这种方式我觉得是最简便的，也是我最常用的。所以我写在最前面，后面两种让我娓娓道来。</p>
<h5 id="方案二使用Spring框架的ApplicationContextAware扩展点"><a href="#方案二使用Spring框架的ApplicationContextAware扩展点" class="headerlink" title="方案二使用Spring框架的ApplicationContextAware扩展点"></a>方案二使用Spring框架的ApplicationContextAware扩展点</h5><p>实现<code>org.springframework.context.ApplicationContextAware</code>接口，可以拿到<code>ApplicationContext</code>也就意味着可以拿到Spring容器中的所有Bean，既然拿到了所有的Bean，那我们就可以遍历其中的Bean，将是我们需要的放入到Map中。Context类进行修改，类名我也改成了<code>RewardSendStrategyFactory</code>,具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RewardSendStrategyFactory</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存所有策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, RewardSendStrategy&gt; STRATEGY_MAP = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        Map&lt;String, RewardSendStrategy&gt; beans = applicationContext.getBeansOfType(RewardSendStrategy<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">if</span> (MapUtils.isEmpty(beans)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        beans.values().forEach(bean -&gt; STRATEGY_MAP.put(bean.type(), bean));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 奖励类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RewardSendStrategy <span class="title">getStrategyInstance</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"策略实例[&#123;&#125;]"</span>, STRATEGY_MAP);</span><br><span class="line">        <span class="keyword">return</span> STRATEGY_MAP.get(type);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方如何使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ContextConfiguration</span>(locations = &#123;<span class="string">"classpath:spring/spring-dao.xml"</span>,<span class="string">"classpath:spring/spring-service.xml"</span>&#125;)</span><br><span class="line"><span class="meta">@RunWith</span>(value = SpringJUnit4ClassRunner<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">StrategyTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String code = RewardTypeEnum.CASH.getCode();</span><br><span class="line">        RewardSendStrategy strategyInstance = RewardSendStrategyFactory2.getStrategyInstance(code);</span><br><span class="line"></span><br><span class="line">        strategyInstance.sendReward(<span class="number">12L</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="方案三使用Spring框架的InitializingBean扩展点"><a href="#方案三使用Spring框架的InitializingBean扩展点" class="headerlink" title="方案三使用Spring框架的InitializingBean扩展点"></a>方案三使用Spring框架的InitializingBean扩展点</h5><p>具体策略要实现<code>org.springframework.beans.factory.InitializingBean</code>接口。凡是将类交给Spring管理并且实现该接口，Spring在初始化bean的时候会自动执行<code>afterPropertiesSet()</code>方法，此时我们将这个Bean放入一个Map即可。这里我就只展示一个具体策略了，其他都是差不多的，具体的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PointRewardSendStrategy</span> <span class="keyword">implements</span> <span class="title">RewardSendStrategy</span>, <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">type</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RewardTypeEnum.POINT.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTypeMatch</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.equals(type, type());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendReward</span><span class="params">(Long memberId)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"给[&#123;&#125;]发送积分奖品"</span>, memberId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RewardSendStrategyFactory.registerStrategyInstance(type(), <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>细心的小伙伴可能发现了一些问题，如果每个具体策略类都实现 <code>InitializingBean</code> 接口，那么重写的<code>afterPropertiesSet()</code>方法明显是重复代码块，当然这个问题也是可以解决的，这里先按下不表！（不然下篇水文我怎么写）</p>
<p>相应的Context上下文类代码修改如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RewardSendStrategyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存策略集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, RewardSendStrategy&gt; STRATEGY_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加策略实例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strategy</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerStrategyInstance</span><span class="params">(String type, RewardSendStrategy strategy)</span> </span>&#123;</span><br><span class="line">        STRATEGY_MAP.put(type, strategy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取策略实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RewardSendStrategy <span class="title">getStrategyInstance</span><span class="params">(String type)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"策略实例[&#123;&#125;]"</span>, STRATEGY_MAP);</span><br><span class="line">        <span class="keyword">return</span> STRATEGY_MAP.get(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方式如单元测试所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      String rewardType = RewardTypeEnum.POINT.getCode();</span><br><span class="line">      RewardSendStrategy strategy = RewardSendStrategyFactory.getStrategyInstance(rewardType);</span><br><span class="line">      strategy.sendReward(<span class="number">12L</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="其他方案"><a href="#其他方案" class="headerlink" title="其他方案"></a>其他方案</h5><p>方案其实还有很多，例如前文中也说到了基于注解的形式，Spring容器启动的时候扫描指定的注解。这个看自己的想法了，只要符合优质代码的标准，而且能实现功能又没有bug，那都是顶呱呱的方案。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>一千个观众眼中有一千个哈姆雷特。每个人对待任何事物都有自己的看法，一千人就有可能有一千种想法。有些事情看上去是件坏事，可换个角度去解读，反而可能会得到一种不一样思想。</p>
<blockquote>
<p>善恶本有人相、我相、众生相,即是文化。</p>
</blockquote>

      
    </div>
         
            <div>
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>Sam</a>
    </li>
    <li><span>发布时间: </span>2021-02-23 20:29:36</li>
    <li><span>最后更新: </span>2021-02-23 20:59:30</li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/post/d06ff354.html" target="_blank" title="孔乙己“茴”字四种写法引起我对策略模式实现的思考">https://ydstudios.gitee.io/post/d06ff354.html</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网所有文章除特别声明外, 
      禁止未经授权转载，违者依法追究相关法律责任!
    </li>
  </ul>
<div>
         
    <footer class="article-footer">
      <a data-url="https://ydstudios.gitee.io/post/d06ff354.html" data-id="ckmksslfo0068zky1f2ev25jv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%9D%E8%80%83/" rel="tag">思考</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F/" rel="tag">策略模式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/post/3c363844.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer >> </strong>
      <div class="article-nav-title">
        
          分布式锁实现方案到底有哪些
        
      </div>
    </a>
  
  
    <a href="/post/9d74cc19.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older << </strong>
      <div class="article-nav-title">分布式事务解决方案到底有哪些</div>
    </a>
  
</nav>

  
</article>

</section>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 Sam<br>
      <!--Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>-->
      <p>备案号:<a href="http://www.miitbeian.gov.cn/" target="_blank" rel="nofollow">苏ICP备17069935号-1</a></p>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">首页</a>
  
    <a href="/archives" class="mobile-nav-link">归档</a>
  
    <a href="/about" class="mobile-nav-link">关于</a>
  
    <a href="/links" class="mobile-nav-link">友链</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>